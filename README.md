## Custom Species Classification Script

This script processes FASTQ sequence files generated by **ngspeciesid** to classify DNA sequences, calculate species abundances, and produce clean summary tables.

> ⚠️ **Important:** This script is designed to run **only after you have run ngspeciesid**. The `sorted.fastq` files generated by ngspeciesid are required inputs.

---

### Requirements

1. **Input files**
   - `sorted.fastq` → The main sequence file generated by ngspeciesid. Each dataset folder from ngspeciesid should contain one.
   - `taxonomy.tsv` → Reference taxonomy table required for classification.
   - `species_taxid.fasta` → Reference species database used for sequence matching.

   Both `taxonomy.tsv` and `species_taxid.fasta` can be downloaded from EMU’s GitLab repository:  
   [EMU Database on GitLab](https://gitlab.com/treangenlab/emu/-/tree/master/emu_database?ref_type=heads)

2. **Software dependencies**
   - Python 3 with `pandas` installed
   - `seqkit` → Converts FASTQ files to FASTA
   - `vsearch` → Performs sequence matching against the reference database
   - Standard Unix tools like `awk` (usually available on Linux/macOS)

---

### How the Script Works

1. Place your `sorted.fastq` files in folders inside your main directory. Each folder should correspond to a dataset from ngspeciesid.
2. Make sure `taxonomy.tsv` and `species_taxid.fasta` are in the same directory where you run this script.
3. For each `sorted.fastq` file, the script:
   - Copies it to a **temporary directory** (your original file stays unchanged)
   - Converts it to FASTA format (`sorted.fasta`) using `seqkit`
   - Matches sequences against `species_taxid.fasta` using `vsearch`
   - Combines results with `taxonomy.tsv` to classify sequences
   - Calculates relative abundances for each species
   - Removes duplicate species and saves a clean TSV summary
4. Output TSV files are named after the dataset folder and organized into subfolders based on the first three letters of the folder name.

---

### Output

For each dataset, the script produces a TSV file containing:

- Sequence IDs
- Identity scores
- Taxonomy information
- Relative species abundances

This gives a clear view of which species are present in your samples and their proportions.

---

### Summary

- **Input:** `sorted.fastq` (from ngspeciesid), `taxonomy.tsv`, `species_taxid.fasta`  
- **Processing:** Copies, converts, matches sequences, merges taxonomy, computes abundance, removes duplicates  
- **Output:** Clean TSV files per dataset folder  

✅ **Tip:** Do not modify `sorted.fastq`. The script works directly on ngspeciesid output and keeps your original files safe.
